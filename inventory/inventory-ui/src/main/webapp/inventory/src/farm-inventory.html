<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="shared-styles.html">

<dom-module id="farm-inventory">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      paper-fab.green {
        --paper-fab-background: var(--paper-green-500);
        --paper-fab-keyboard-focus-background: var(--paper-green-900);
        float: right;
      }

      paper-fab.blue {
        --paper-fab-background: var(--paper-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-blue-900);
        float: right;
      }
    </style>

    <paper-dialog id="modelInventoryConfirm">
      <p>Saved with code: {{inventoryCode}}</p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="modalCatalogConfirm">
      <p>Saved. Looks delicious :-)</p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="modalDuplicate">
      <p>This item already exists in the catalog</p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>Close</paper-button>
      </div>
    </paper-dialog>

    <div class="card">
      <paper-fab id="addCatalogButton" icon="add" title="add" class="green" on-click="toggle"></paper-fab>

      <h1>Search Catalog Items</h1>

       <iron-collapse id="collapse">
         <div>
          <form is="iron-form" method="get" action="/" id="catalogItemForm">
            <paper-input id="itemCategory" label="Item category" required auto-validate></paper-input>
            <paper-input id="itemName" label="Item name" required auto-validate></paper-input>
            <paper-input id="itemRetailPrice" label="Retail price" required auto-validate pattern="[+-]?[0-9]{1,3}(?:,?[0-9]{3})*\.[0-9]{2}" error-message="Enter number with 2 decimal places"><div prefix>$</div></paper-input>
            <paper-input id="itemWholeSalePrice" label="Wholesale price" required auto-validate pattern="[+-]?[0-9]{1,3}(?:,?[0-9]{3})*\.[0-9]{2}" error-message="Enter number with 2 decimal places"><div prefix>$</div></paper-input>
            <paper-button raised style="float:right" on-click="saveCatalogItem"><iron-icon icon="save"></iron-icon>Save</paper-button>
            <paper-button raised style="float:right" on-click="clearEntryForm"><iron-icon icon="clear"></iron-icon>Clear</paper-button>
          </form>
            <br />
            <br />
         </div>
       </iron-collapse>

        <paper-input id="searchString" label="Enter your search terms (e.g. chicken)" required on-keyup="updateCatalogView"></paper-input>
      
        <p><strong>Results</strong></p>

        
          <div>
              <template is="dom-repeat" items="{{categories}}">
                  <paper-card style="width:100%">
                    <table style="width:100%">
                      <tr>
                        <td style="width:40%; padding-left:15px">
                            <strong>{{item.name}}&nbsp; </strong><span style="font-size:0.85em; color:#a7a7a7">{{item.unitsAvailable}}&nbsp;units&nbsp;available</span>
                            <br />
                            <span style="color:#000000; font-size: 0.8em">{{item.category}}</span>
                        </td>
                        <td style="width:20%">
                          <paper-button id="{{getCatalogEditButtonId(item.id)}}" style="float:right;" on-click="toggleItemEdit">
                            <iron-icon id={{getCatalogEditFormToggleIconId(item.id)}} icon="add"></iron-icon>
                          </paper-button>
                        </td>
                      </tr>
                    </table>
                  </paper-card>
                  <iron-collapse id="{{getCatalogCollapseId(item.id)}}">
                    <paper-card style="width:100%">
                      <div style="padding:10px">
                         <form is="iron-form" method="get" action="/" id="{{getCatalogEditFormId(item.id)}}">
                            Add {{item.name}} to inventory</strong>)
                            <paper-input id="{{getInventoryInputId(item.id)}}" label="Item weight" required auto-validate pattern="[+-]?[0-9]{1,3}(?:,?[0-9]{3})*\.[0-9]{1,4}" error-message="Enter number with 1 to 4 decimal places"></paper-input>
                            <paper-button id="{{getInventoryFormButtonId(item.id)}}" on-click="saveInventoryItem">
                                <iron-icon icon="save"></iron-icon>Save
                            </paper-button>
                         </form>
                      </div>
                    </paper-card>
                  </iron-collapse>
                  <br />
              </template>
          </div>

      </table>
    </div>

    <iron-ajax
        id="catalogGetDatasource"
        params='{{getCatalogReadParams(searchString)}}'
        handle-as="json"
        on-response="handleGetResponse">
    </iron-ajax>

    <iron-ajax
        id="catalogPutDatasource"
        params='{{getCatalogWriteParams(catalogItemCategory, catalogItemName, catalogItemRetailPrice, catalogItemWholesalePrice)}}'
        handle-as="json"
        on-response="handlePutResponse">
    </iron-ajax>

    <iron-ajax
        id="inventoryPutDatasource"
        handle-as="json"
        on-response="handleInventoryPutResponse">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'farm-inventory',

      properties: {
          categories: {
              type: Array
          },

          searchString: 'all',
          catalogId: '',
          catalogItemCategory: '',
          catalogItemName: '',
          catalogItemRetailPrice: '',
          catalogItemWholesalePrice: '',
          inventoryMeasure: '',
          inventoryCode: {
            value: '',
            reflectToAttribute: true
          }
      },

      //-------------------------------------------------------------------------
      // Page events
      //-------------------------------------------------------------------------
      ready: function () {
          this.$.catalogGetDatasource.url = appProperties.inventoryServiceGetCatalogEntriesServicePath;
          this.$.catalogPutDatasource.url = appProperties.inventoryServiceCreateCatalogEntryServicePath;
          this.$.inventoryPutDatasource.url = appProperties.inventoryCreateInventoryItemServicePath;

          this.searchString = 'all';
          this.$.catalogGetDatasource.generateRequest();
      },

      //-------------------------------------------------------------------------
      // AJAX Event Handlers
      //-------------------------------------------------------------------------
      handleGetResponse: function (data) {
          this.categories = data.detail.response;
      },
      handlePutResponse: function (data) {
          var response = data.detail.response;

          if(response.result != 0){
            this.$.modalDuplicate.open();
          }
          else {
            this.searchString = this.catalogItemName;
            this.$.catalogGetDatasource.generateRequest();
            this.clearEntryForm();
            this.$.modalCatalogConfirm.open();
          }
          
      },
      handleInventoryPutResponse: function (data) {
        var response = data.detail.response;

        if(response.result != 0){
          // Some kind of error handling here
        }
        else {
          this.inventoryCode = response.code;
          var formCollapseTarget = this.$$("#collapse_" + this.catalogId);
          var formCollapseIcon = this.$$("#editIcon_" + this.catalogId);

          formCollapseTarget.toggle();
          formCollapseIcon.icon = 'add';

          this.$.modelInventoryConfirm.open();
        }
      },

      //-------------------------------------------------------------------------
      // AJAX Parameter Bindings
      //-------------------------------------------------------------------------
      getCatalogReadParams: function(pSearchString){
          return {searchString: pSearchString.trim()};
      },
      getCatalogWriteParams: function(pCatalogItemCategory, pCatalogItemName, 
                                      pCatalogItemRetailPrice, pCatalogItemWholesalePrice){
          return {category: pCatalogItemCategory,
                  name: pCatalogItemName,
                  retailPrice: pCatalogItemRetailPrice,
                  wholesalePrice: pCatalogItemWholesalePrice};
      },
      getInventoryWriteParams: function(pCatalogId, pMeasure){
          return {catalog_id: pCatalogId,
                  measure: pMeasure};
      },
      
      //-------------------------------------------------------------------------
      // Form validators
      //-------------------------------------------------------------------------
      validate: function() {
        return (this.$.itemCategory.validate() &&  this.$.itemName.validate() &&
                this.$.itemRetailPrice.validate() && this.$.itemWholeSalePrice.validate())
      },

      //-------------------------------------------------------------------------
      // Button/element event handlers
      //-------------------------------------------------------------------------
      updateCatalogView: function () {
          var currValue = this.$.searchString.value;
          this.searchString = currValue;
          this.$.catalogGetDatasource.generateRequest();
      },

      saveCatalogItem: function (){
        if(this.validate()){
          this.catalogItemCategory = this.$.itemCategory.value;
          this.catalogItemName = this.$.itemName.value;
          this.catalogItemRetailPrice = this.$.itemRetailPrice.value;
          this.catalogItemWholesalePrice = this.$.itemWholeSalePrice.value;

          this.$.catalogPutDatasource.generateRequest();
          this.toggle();
        }

      },
      
      clearEntryForm: function() {
         this.$.catalogItemForm.reset();
      },

      toggleItemEdit: function(e){
        var formCollapseTarget = this.$$("#collapse_" + e.currentTarget.id.substring(5));
        var formCollapseIcon = this.$$("#editIcon_" + e.currentTarget.id.substring(5));

        if(formCollapseIcon.icon == 'add'){
            formCollapseIcon.icon = "close";
        }
        else{
            formCollapseIcon.icon = "add";
        }

        formCollapseTarget.toggle();
      },

      saveInventoryItem: function(e) {
        this.catalogId = e.currentTarget.id.substring(8);
        this.inventoryMeasure = this.$$("#invInput_" + this.catalogId).value;

        this.$.inventoryPutDatasource.params = this.getInventoryWriteParams(this.catalogId, this.inventoryMeasure);
        this.$.inventoryPutDatasource.generateRequest();

      },

      //-------------------------------------------------------------------------
      // ID Generators for Dynamic Elements
      //-------------------------------------------------------------------------
      getCatalogEditFormId: function(categoryId){
        return "editForm_" + categoryId;
      },
      getCatalogEditFormToggleIconId: function(categoryId){
        return "editIcon_" + categoryId;
      },
      getInventoryInputId: function(categoryId){
        return "invInput_" + categoryId;
      },
      getInventoryFormButtonId: function(categoryId){
        return "invSave_" + categoryId;
      },
      getCatalogCollapseId: function(categoryId) {
        return "collapse_" + categoryId;
      },
      getCatalogEditButtonId: function(categoryId){
        return "edit_" + categoryId;
      },

      //-------------------------------------------------------------------------
      // Utility methods and helpers
      //-------------------------------------------------------------------------
      formatCurrencyDecimal: function(inputNumber) {
        return inputNumber.toFixed(2);
      },
      toggle: function() {
        this.$.collapse.toggle();

        if(this.$.addCatalogButton.icon == "add"){
          this.$.addCatalogButton.icon = "close";
        }
        else{
          this.$.addCatalogButton.icon = "add";
        }
      },
      getInventoryCode: function() {
        return this.inventoryCode;
      }

    });

    
  </script>
</dom-module>
